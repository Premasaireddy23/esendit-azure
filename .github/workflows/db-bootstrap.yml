name: DB Bootstrap (Admin + Roles + Permissions)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Backend image tag that contains dist/scripts/bootstrap.js"
        required: true
      namespace:
        description: "K8s namespace"
        required: true
        default: "esendit"

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Your login steps here (kubectl context + ACR login etc.)
      # - az login ...
      # - az aks get-credentials ...

      - name: Run bootstrap (K8s Job)
        shell: bash
        run: |
          set -euo pipefail

          TAG="${{ inputs.tag }}"
          NAMESPACE="${{ inputs.namespace }}"
          JOB="esendit-bootstrap-${TAG:0:12}"

          ACR_LOGIN_SERVER="${{ secrets.ACR_LOGIN_SERVER }}"
          IMAGE="${ACR_LOGIN_SERVER}/esendit-backend:${TAG}"

          kubectl -n "$NAMESPACE" delete job "$JOB" --ignore-not-found

          cat <<EOF | kubectl -n "$NAMESPACE" apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: ${JOB}
          spec:
            ttlSecondsAfterFinished: 900
            backoffLimit: 3
            template:
              spec:
                restartPolicy: Never
                containers:
                - name: bootstrap
                  image: ${IMAGE}
                  envFrom:
                  - secretRef:
                      name: esendit-secrets
                  - secretRef:
                      name: esendit-bootstrap-secrets
                  command: ["sh","-lc"]
                  args:
                    - |
                      echo "Bootstrapping admin/roles/permissions..."
                      node dist/scripts/bootstrap.js
          EOF

          kubectl -n "$NAMESPACE" wait --for=condition=complete "job/$JOB" --timeout=10m
