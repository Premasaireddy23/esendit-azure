name: dev-backend-deploy

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Backend image tag in ACR (e.g. abc1234)"
        required: true
      run_migrate:
        description: "Run prisma migrate deploy (only when backend/prisma changed)"
        type: boolean
        required: true
        default: false
      run_bootstrap:
        description: "Run bootstrap admin/roles/perms (rare; new env / permission changes)"
        type: boolean
        required: true
        default: false

permissions:
  id-token: write
  contents: read

env:
  ACR_LOGIN_SERVER: acresenditdevesendit000.azurecr.io
  AKS_RG: rg-esendit-dev-aks-ci
  AKS_NAME: aks-esendit-dev-esendit000
  NAMESPACE: esendit

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Set AKS context
        uses: azure/aks-set-context@v4
        with:
          resource-group: ${{ env.AKS_RG }}
          cluster-name: ${{ env.AKS_NAME }}
          admin: true

      - name: Apply manifests if present
        run: |
          set -euo pipefail
          if [ -d "azure/infra/terraform/esendit/k8s-app/overlays/dev" ]; then
            kubectl -n $NAMESPACE apply -k azure/infra/terraform/esendit/k8s-app/overlays/dev
          else
            echo "No kustomize overlay found, skipping apply."
          fi

      - name: Prisma migrate deploy (optional)
        if: ${{ inputs.run_migrate }}
        run: |
          set -euo pipefail
          TAG="${{ inputs.tag }}"
          SHORT="${TAG:0:12}"
          JOB="esendit-migrate-${SHORT}"

          kubectl -n "$NAMESPACE" delete job "$JOB" --ignore-not-found

          cat <<EOF | kubectl -n "$NAMESPACE" apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: esendit-migrate-<TAGSHORT>
            namespace: esendit
          spec:
            ttlSecondsAfterFinished: 900
            backoffLimit: 3
            template:
              spec:
                restartPolicy: Never
                serviceAccountName: esendit-backend-sa
                volumes:
                  - name: kv-secrets
                    csi:
                      driver: secrets-store.csi.k8s.io
                      readOnly: true
                      volumeAttributes:
                        secretProviderClass: esendit-secrets
                containers:
                  - name: migrate
                    image: <ACR_LOGIN_SERVER>/esendit-backend:<TAG>
                    volumeMounts:
                      - name: kv-secrets
                        mountPath: /mnt/secrets-store
                        readOnly: true
                    command: ["sh","-lc"]
                    args:
                      - |
                        set -euo pipefail
                        export PG_URL="$(cat /mnt/secrets-store/pg-connection-url)"
                        export DATABASE_URL="$PG_URL"
                        echo "DB host:"; echo "$DATABASE_URL" | sed "s/:.*@/:***@/g"
                        npx prisma migrate deploy
          EOF

          kubectl -n "$NAMESPACE" wait --for=condition=complete "job/$JOB" --timeout=10m

      - name: Bootstrap admin/roles/perms (optional)
        if: ${{ inputs.run_bootstrap }}
        run: |
          set -euo pipefail
          TAG="${{ inputs.tag }}"
          SHORT="${TAG:0:12}"
          JOB="esendit-bootstrap-${SHORT}"

          kubectl -n "$NAMESPACE" delete job "$JOB" --ignore-not-found

          cat <<EOF | kubectl -n "$NAMESPACE" apply -f -
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: esendit-bootstrap-<TAGSHORT>
            namespace: esendit
          spec:
            ttlSecondsAfterFinished: 900
            backoffLimit: 3
            template:
              spec:
                restartPolicy: Never
                serviceAccountName: esendit-backend-sa
                volumes:
                  - name: kv-secrets
                    csi:
                      driver: secrets-store.csi.k8s.io
                      readOnly: true
                      volumeAttributes:
                        secretProviderClass: esendit-secrets
                containers:
                  - name: bootstrap
                    image: <ACR_LOGIN_SERVER>/esendit-backend:<TAG>
                    envFrom:
                      - secretRef:
                          name: esendit-bootstrap-secrets
                    volumeMounts:
                      - name: kv-secrets
                        mountPath: /mnt/secrets-store
                        readOnly: true
                    command: ["sh","-lc"]
                    args:
                      - |
                        set -euo pipefail
                        export PG_URL="$(cat /mnt/secrets-store/pg-connection-url)"
                        export DATABASE_URL="$PG_URL"
                        node dist/scripts/bootstrap.js
          EOF

          kubectl -n "$NAMESPACE" wait --for=condition=complete "job/$JOB" --timeout=10m

      - name: Update backend image + rollout
        run: |
          set -euo pipefail
          TAG="${{ inputs.tag }}"

          set_image () {
            local deploy="$1"
            local image="$2"
            local cname
            cname="$(kubectl -n "$NAMESPACE" get deploy "$deploy" -o jsonpath='{.spec.template.spec.containers[0].name}')"

            echo "Before ($deploy):"
            kubectl -n "$NAMESPACE" get deploy "$deploy" \
              -o jsonpath='{.spec.template.spec.containers[0].name}{" => "}{.spec.template.spec.containers[0].image}{"\n"}'
            echo

            kubectl -n "$NAMESPACE" set image "deploy/$deploy" "$cname=$image"

            echo "After ($deploy):"
            kubectl -n "$NAMESPACE" get deploy "$deploy" \
              -o jsonpath='{.spec.template.spec.containers[0].name}{" => "}{.spec.template.spec.containers[0].image}{"\n"}'
            echo

            kubectl -n "$NAMESPACE" rollout status "deploy/$deploy" --timeout=10m
          }

          set_image "esendit-backend" "${ACR_LOGIN_SERVER}/esendit-backend:${TAG}"

      - name: Smoke test
        run: |
          set -euo pipefail
          IP="$(kubectl -n ingress-nginx get svc ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}')"
          curl -fsS "http://$IP/api/health"
